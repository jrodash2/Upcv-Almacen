{% extends 'almacen/base.html' %}
{% load static %}

{% block content %}

<!-- Cargar jQuery y DataTables -->
<script src="{% static 'assets/js/jquery.min.js' %}"></script>
<script src="{% static 'assets/js/datatable/datatables/jquery.dataTables.min.js' %}"></script>
<script src="{% static 'assets/js/datatable/datatables/datatable.custom.js' %}"></script>

<div class="page-body">
  <div class="container-fluid">
    <div class="page-title">
      <div class="row">
        <div class="col-6">
          <h4 class="card-title mb-0">Asignar artículo desde Detalle de Factura</h4>
        </div>
        <div class="col-6">
          <ol class="breadcrumb">
            <li class="breadcrumb-item">
              <a href="">
                <svg class="stroke-icon">
                  <use href="{% static 'assets/svg/icon-sprite.svg#stroke-home' %}"></use>
                </svg>
              </a>
            </li>
            <li class="breadcrumb-item">Almacén</li>
            <li class="breadcrumb-item active">Asignación</li>
          </ol>
        </div>
      </div>
    </div>
  </div>

  <!-- Container-fluid -->
<div class="container-fluid">
  <div class="row">

    <!-- Columna del formulario (9 columnas) -->
    <div class="col-xl-9">
      <div class="card">
        <div class="card-body">

          <!-- Formulario -->
          <form method="post" id="asignacion-form">
            {% csrf_token %}
            {{ form.as_p }}

            <div id="stock-info" style="margin-top: 10px; font-weight: bold;">
              Cantidad en stock: <span id="stock-cantidad"></span>
            </div>

            <div class="form-footer text-end mt-3">
              <button type="submit" class="btn btn-primary">Asignar</button>
            </div>
          </form>

        </div>
      </div>
    </div>

   {% if ultima_asignacion %}
<div class="col-xl-3">
  <div class="card border mt-2 mt-xl-0 h-30">
    <div class="card-footer p-0">
      <div class="common-space px-3 py-2">
        <div>
          <a class="f-w-600 f-10" href="#">Última Asignación</a>
          <span class="f-light f-w-400 f-10 d-block">Detalles del último registro:</span>
        </div>
      </div>
    </div>
    <div class="card-body pt-2 pb-3 px-3">
      <ul class="mb-0 list-unstyled">
        <li><span class="f-w-600 f-10">Artículo:</span> <span class="f-light f-10">{{ ultima_asignacion.articulo.nombre }}</span></li>
        <li><span class="f-w-600 f-10">Departamento:</span> <span class="f-light f-10">{{ ultima_asignacion.destino.nombre }}</span></li>
        <li><span class="f-w-600 f-10">Cantidad asignada:</span> <span class="f-light f-10">{{ ultima_asignacion.cantidad_asignada }}</span></li>
        <li><span class="f-w-600 f-10">Fecha:</span> <span class="f-light f-10">{{ ultima_asignacion.fecha_asignacion }}</span></li>
      </ul>
    </div>
  </div>
</div>
{% endif %}


  </div>
</div>
<!-- Container-fluid ends -->


<!-- Script para stock dinámico -->
<script>
  const stockPorArticulo = {{ stock_dict|safe }};
  const articuloSelect = document.querySelector('select[name="articulo"]');
  const stockCantidadSpan = document.getElementById('stock-cantidad');

  if (articuloSelect) {
    articuloSelect.addEventListener('change', function () {
      const articuloId = parseInt(this.value);
      if (articuloId && stockPorArticulo[articuloId] !== undefined) {
        stockCantidadSpan.textContent = stockPorArticulo[articuloId];
      } else {
        stockCantidadSpan.textContent = '';
      }
    });

    articuloSelect.dispatchEvent(new Event('change'));
  }
</script>

{% endblock %}
